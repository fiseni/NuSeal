<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <!-- These targets will run for author's packages (packages that have installed the NuSeal package). -->

  <!-- ############################################################################################### -->
  <ItemGroup Condition="'$(NuSealValidationScope)' == 'Direct'">
    <PackageReference Update="NuSeal" PrivateAssets="contentfiles;analyzers;build;buildTransitive" />
  </ItemGroup>

  <!-- ############################################################################################### -->
  <Target Name="NuSealCheckDirectReference"
          BeforeTargets="BeforeCompile">

    <PropertyGroup>
      <NuSealIsPackageReferenced>@(PackageReference->WithMetadataValue('Identity', 'NuSeal')->'%(Identity)'->Count())</NuSealIsPackageReferenced>
      <NuSealVersion>@(PackageReference->WithMetadataValue('Identity', 'NuSeal')->'%(Version)')</NuSealVersion>
    </PropertyGroup>

  </Target>

  <!-- ############################################################################################### -->
  <Target Name="NuSealInjectProtectedAttribute"
          BeforeTargets="BeforeCompile"
          DependsOnTargets="NuSealCheckDirectReference"
          Condition="$(NuSealIsPackageReferenced) != 0">

    <ItemGroup>
      <AssemblyAttribute Include="NuSeal.NuSealProtectedAttribute" />
    </ItemGroup>

  </Target>

  <!-- ############################################################################################### -->
  <Target Name="NuSealInjectValidationModeAttribute"
          BeforeTargets="BeforeCompile"
          DependsOnTargets="NuSealCheckDirectReference"
          Condition="$(NuSealIsPackageReferenced) != 0 And '$(NuSealValidationMode)' != ''">

    <ItemGroup>
      <AssemblyAttribute Include="NuSeal.NuSealValidationModeAttribute">
        <_Parameter1>$(NuSealValidationMode)</_Parameter1>
      </AssemblyAttribute>
    </ItemGroup>

  </Target>

  <!-- ############################################################################################### -->
  <Target Name="NuSealInjectValidationScopeAttribute"
          BeforeTargets="BeforeCompile"
          DependsOnTargets="NuSealCheckDirectReference"
          Condition="$(NuSealIsPackageReferenced) != 0 And '$(NuSealValidationScope)' != ''">

    <ItemGroup>
      <AssemblyAttribute Include="NuSeal.NuSealValidationScopeAttribute">
        <_Parameter1>$(NuSealValidationScope)</_Parameter1>
      </AssemblyAttribute>
    </ItemGroup>

  </Target>

  <!-- ############################################################################################### -->
  <Target Name="NuSealDirectValidationScope"
          BeforeTargets="Build"
          DependsOnTargets="NuSealCheckDirectReference"
          Condition="$(NuSealIsPackageReferenced) != 0 And '$(NuSealValidationScope)' == 'Direct'">

    <NuSeal.PrepareAssetsForConsumerTask
        NuSealAssetsPath="$(MSBuildThisFileDirectory)"
        NuSealVersion="$(NuSealVersion)"
        OutputPath="$(OutputPath)"
        ConsumerPackageId="$(PackageId)"
        ConsumerPropsFile="$(NuSealIncludePropsFile)"
        ConsumerTargetsFile="$(NuSealIncludeTargetsFile)" />

    <ItemGroup Label="Packaging build assets">
      <None Include="$(OutputPath)\$(PackageId).props" Pack="true" PackagePath="build\$(PackageId).props" Visible="false"/>
      <None Include="$(OutputPath)\$(PackageId).targets" Pack="true" PackagePath="build\$(PackageId).targets" Visible="false"/>
    </ItemGroup>
  </Target>

  <!-- ############################################################################################### -->
  <!-- This target will run for the end user -->
  <Target Name="NuSealLicenseValidation"
        AfterTargets="AfterBuild"
        Condition="'$(OutputType)' == 'Exe' Or '$(OutputType)' == 'WinExe' Or '$(MSBuildProjectSdk)' == 'Microsoft.NET.Sdk.Web'">

    <NuSeal.LicenseValidationTask MainAssemblyPath="$(TargetPath)" />
  </Target>
  
</Project>
